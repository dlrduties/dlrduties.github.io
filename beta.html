<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OwnGOAL Calendar Test</title>
    <style>
        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 16px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        h1 {
            color: #1e88e5;
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
        }

        input, button {
            height: 44px;
            background-color: #1e1e1e;
            color: #ffffff;
            border: 1px solid #424242;
            border-radius: 5px;
            font-size: 14px;
            width: 100%;
            padding: 0 12px;
            margin-bottom: 12px;
        }

        button {
            background-color: #1e88e5;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover { background-color: #1565c0; }
        button:disabled { background-color: #424242; cursor: not-allowed; }

        .splash-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #121212;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .splash-content {
            text-align: center;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
        }

        .splash-title { color: #1e88e5; margin-bottom: 20px; font-size: 24px; }

        .login-fields {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 18px;
            color: #1e88e5;
        }

        .url-display {
            background-color: #121212;
            border: 1px solid #424242;
            border-radius: 5px;
            padding: 12px;
            word-break: break-all;
            font-family: monospace;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .warning {
            background-color: rgba(255, 152, 0, 0.1);
            border: 1px solid #ff9800;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #ffb74d;
        }

        .success {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 12px;
            color: #81c784;
        }

        .error { color: #e53935; margin-top: 8px; }

        .info-text { color: #888; font-size: 14px; margin-bottom: 16px; }

        .button-row { display: flex; gap: 8px; }
        .button-row button { flex: 1; }

        .btn-secondary { background-color: #424242; }
        .btn-secondary:hover { background-color: #616161; }

        .btn-danger { background-color: #c62828; }
        .btn-danger:hover { background-color: #e53935; }

        a { color: #1e88e5; }

        .button-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-content">
            <h1 class="splash-title">Calendar Subscription Test</h1>
            <div id="loginForm">
                <p>Please sign in</p>
                <div class="login-fields">
                    <input type="email" id="emailInput" placeholder="Email">
                    <input type="password" id="passwordInput" placeholder="Password">
                    <button id="loginButton" onclick="signIn()">Sign In</button>
                    <a href="#" onclick="showPasswordResetForm(); return false;" style="font-size: 14px; margin-top: 12px; display: inline-block;">Reset Password</a>
                </div>
                <p id="loginError" class="error" style="display: none;"></p>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="passwordResetModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); z-index: 1010; justify-content: center; align-items: center;">
        <div style="background-color: #1e1e1e; border-radius: 8px; padding: 20px; width: 90%; max-width: 400px;">
            <h3 style="color: #1e88e5; margin-top: 0;">Reset Password</h3>
            <p style="margin-bottom: 20px;">Enter your email address to receive a link to reset your password.</p>
            
            <div style="display: flex; flex-direction: column;">
                <input type="email" id="resetEmailInput" placeholder="Email" style="margin-bottom: 16px;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="sendPasswordReset()" style="flex: 1;">Send Reset Link</button>
                    <button onclick="hidePasswordResetForm()" style="background-color: #424242; flex: 1;">Cancel</button>
                </div>
            </div>
            <p id="resetMessage" style="margin-top: 16px; display: none;"></p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container" id="mainContent" style="display: none;">
        <h1>Calendar Subscription</h1>

        <!-- No existing token - show generator -->
        <div id="generateSection" class="card">
            <h2>Generate Calendar URL</h2>
            
            <p class="info-text">Enter your employee number to generate a subscription URL for Outlook or Google Calendar.</p>
            
            <input type="text" id="employeeNumber" placeholder="Employee Number (e.g. 300123)" maxlength="6">
            
            <div class="warning">
                <strong>Warning:</strong> Anyone with this URL can view your duties. Only share it with calendar apps you trust. You can revoke it at any time.
            </div>
            
            <button id="generateBtn" onclick="generateToken()">Generate Calendar URL</button>
            <p id="generateError" class="error" style="display: none;"></p>
        </div>
        
        <!-- No employee number linked -->
        <div id="noEmployeeSection" class="card hidden">
            <h2>Account Not Set Up</h2>
            <p>Your account hasn't been linked to an employee number yet. Please contact your administrator.</p>
        </div>

        <!-- Existing token - show URL -->
        <div id="existingSection" class="card hidden">
            <h2>Your Calendar URL</h2>
            
            <div class="success">✓ Calendar subscription active</div>
            
            <p class="info-text">Copy this URL and add it as a subscription in your calendar app:</p>
            
            <div class="url-display" id="calendarUrl"></div>
            
            <div class="button-row">
                <button onclick="copyUrl()">Copy URL</button>
                <button class="btn-secondary" onclick="testUrl()">Test in Browser</button>
            </div>
            
            <p id="tokenInfo" class="info-text" style="margin-top: 16px; margin-bottom: 0;"></p>
            
            <button class="btn-danger" onclick="revokeToken()" style="margin-top: 16px;">Revoke URL</button>
        </div>

        <a href="#" onclick="signOut(); return false;">Sign Out</a>
    </div>

    <script>
        // ============================================
        // CHANGE THIS TO YOUR CLOUD FUNCTION URL
        // ============================================
        const CALENDAR_FUNCTION_URL = 'https://us-central1-owngoal-4f34f.cloudfunctions.net/calendarFeed';
        // ============================================

        let currentUser = null;
        let currentToken = null;
        let currentEmployeeNumber = null;
        let isAdmin = false;

        // Firebase init
        function loadFirebase() {
            const loadScript = (src, callback) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = callback;
                document.body.appendChild(script);
            };

            loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js', () => {
                loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js', () => {
                    loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js', () => {
                        const firebaseConfig = {
                            apiKey: "AIzaSyBkKclvdWHVQ58IFG_ap0ByJA_2a8J2YXU",
                            authDomain: "owngoal-4f34f.firebaseapp.com",
                            projectId: "owngoal-4f34f",
                            storageBucket: "owngoal-4f34f.firebasestorage.app",
                            messagingSenderId: "270078133518",
                            appId: "1:270078133518:web:36ef7431fda632bed1c35f"
                        };

                        firebase.initializeApp(firebaseConfig);
                        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);

                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                currentUser = user;
                                checkExistingToken();
                            }
                        });

                        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') signIn();
                        });
                    });
                });
            });
        }

        function signIn() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginButton');

            if (!email || !password) {
                errorEl.textContent = "Please enter both email and password";
                errorEl.style.display = "block";
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="button-spinner"></span>Signing in...';
            errorEl.style.display = "none";

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    checkExistingToken();
                })
                .catch((error) => {
                    errorEl.textContent = error.code === 'auth/invalid-login-credentials' 
                        ? "Incorrect email or password." 
                        : error.message;
                    errorEl.style.display = "block";
                    btn.disabled = false;
                    btn.innerHTML = 'Sign In';
                });
        }

        function signOut() {
            firebase.auth().signOut().then(() => {
                document.getElementById('splashScreen').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('emailInput').value = '';
                document.getElementById('passwordInput').value = '';
                document.getElementById('loginButton').disabled = false;
                document.getElementById('loginButton').innerHTML = 'Sign In';
                currentUser = null;
                currentToken = null;
                currentEmployeeNumber = null;
                isAdmin = false;
            });
        }

        function showPasswordResetForm() {
            const modal = document.getElementById('passwordResetModal');
            modal.style.display = 'flex';
            const loginEmail = document.getElementById('emailInput').value;
            if (loginEmail) {
                document.getElementById('resetEmailInput').value = loginEmail;
            }
            document.getElementById('resetMessage').style.display = 'none';
        }

        function hidePasswordResetForm() {
            document.getElementById('passwordResetModal').style.display = 'none';
        }

        function sendPasswordReset() {
            const email = document.getElementById('resetEmailInput').value;
            const messageEl = document.getElementById('resetMessage');

            if (!email) {
                messageEl.textContent = "Please enter your email address";
                messageEl.style.color = "#e53935";
                messageEl.style.display = "block";
                return;
            }

            firebase.auth().sendPasswordResetEmail(email)
                .then(() => {
                    messageEl.textContent = "Password reset email sent! Check your inbox.";
                    messageEl.style.color = "#4caf50";
                    messageEl.style.display = "block";
                    setTimeout(() => hidePasswordResetForm(), 3000);
                })
                .catch((error) => {
                    const msg = error.code === 'auth/user-not-found' 
                        ? "No account found with this email address"
                        : error.code === 'auth/invalid-email'
                        ? "Please enter a valid email address"
                        : "Error: " + error.message;
                    messageEl.textContent = msg;
                    messageEl.style.color = "#e53935";
                    messageEl.style.display = "block";
                });
        }

        async function checkExistingToken() {
            const db = firebase.firestore();
            
            try {
                // First, get the user's employee number
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    showNoEmployeeSection();
                    document.getElementById('splashScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    return;
                }
                
                currentEmployeeNumber = userDoc.data().employeeNumber;
                isAdmin = userDoc.data().isAdmin === true;
                
                // Then check for existing token
                const snapshot = await db.collection('calendarTokens')
                    .where('uid', '==', currentUser.uid)
                    .limit(1)
                    .get();

                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    currentToken = doc.id;
                    const data = doc.data();
                    
                    showExistingToken(currentToken, data);
                } else {
                    showGenerateSection();
                }

                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Error checking token:', error);
                showNoEmployeeSection();
                document.getElementById('splashScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }
        }

        function showNoEmployeeSection() {
            document.getElementById('generateSection').classList.add('hidden');
            document.getElementById('existingSection').classList.add('hidden');
            document.getElementById('noEmployeeSection').classList.remove('hidden');
        }

        function showGenerateSection() {
            document.getElementById('generateSection').classList.remove('hidden');
            document.getElementById('existingSection').classList.add('hidden');
            document.getElementById('noEmployeeSection').classList.add('hidden');
        }

        function showExistingToken(token, data) {
            document.getElementById('generateSection').classList.add('hidden');
            document.getElementById('existingSection').classList.remove('hidden');
            document.getElementById('noEmployeeSection').classList.add('hidden');
            
            const url = `${CALENDAR_FUNCTION_URL}/${token}`;
            document.getElementById('calendarUrl').textContent = url;
            
            let info = `Employee: ${data.employeeNumber}`;
            if (data.createdAt) {
                const created = data.createdAt.toDate();
                info += ` • Created: ${created.toLocaleDateString()}`;
            }
            document.getElementById('tokenInfo').textContent = info;
        }

        async function generateToken() {
            const employeeNumber = document.getElementById('employeeNumber').value.trim();
            const errorEl = document.getElementById('generateError');
            const btn = document.getElementById('generateBtn');

            if (!employeeNumber || !/^\d{6}$/.test(employeeNumber)) {
                errorEl.textContent = "Please enter a valid 6-digit employee number";
                errorEl.style.display = "block";
                return;
            }

            if (!isAdmin && employeeNumber !== currentEmployeeNumber) {
                errorEl.textContent = "That's not your employee number";
                errorEl.style.display = "block";
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="button-spinner"></span>Generating...';
            errorEl.style.display = "none";

            try {
                const token = generateRandomToken(32);
                const db = firebase.firestore();

                await db.collection('calendarTokens').doc(token).set({
                    uid: currentUser.uid,
                    employeeNumber: employeeNumber,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                currentToken = token;
                showExistingToken(token, { employeeNumber, createdAt: { toDate: () => new Date() } });
            } catch (error) {
                errorEl.textContent = "Error generating URL: " + error.message;
                errorEl.style.display = "block";
                btn.disabled = false;
                btn.innerHTML = 'Generate Calendar URL';
            }
        }

        function generateRandomToken(length) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            for (let i = 0; i < length; i++) {
                result += chars[array[i] % chars.length];
            }
            return result;
        }

        function copyUrl() {
            const url = document.getElementById('calendarUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy URL', 2000);
            });
        }

        function testUrl() {
            const url = document.getElementById('calendarUrl').textContent;
            window.open(url, '_blank');
        }

        async function revokeToken() {
            if (!confirm('Are you sure? Any calendar subscriptions using this URL will stop updating.')) {
                return;
            }

            try {
                const db = firebase.firestore();
                await db.collection('calendarTokens').doc(currentToken).delete();
                currentToken = null;
                showGenerateSection();
            } catch (error) {
                alert('Error revoking token: ' + error.message);
            }
        }

        loadFirebase();
    </script>
</body>
</html>
